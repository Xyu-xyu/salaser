import { useEffect, useRef, useState } from "react";
import svgPanZoom from "svg-pan-zoom";
import { Icon } from "@iconify/react";
import parse from "html-react-parser";

const listing: string = `1N1G29X0.00Y0.00P1H1A1
2N2G52X15.000000Y15.090000L1C0.000000
3(Part code="28___10__1")
4N16G28X340Y520L1P1
5N17G0X10Y348.994
6N18G10S1
7M4
8N19G1X8.762563Y352.494
9N20G42
10N21G2X10Y354.244I10J352.9315
11N22G10S0
12N23G1X15.25Y354.244
13N24X15.25Y323.681
14N25X4.75Y323.681
15N26X4.75Y354.244
16N27X10Y354.244
17M5
18N28G40
19N29G0X33.725Y356.934
20N30G10S1
21M4
22N31G1X28.391667Y355.048382
23N32G42
24N33G2X25.725Y356.934I27.725J356.934
25N34G10S0
26N35G1X25.725Y379.937
27N36G2X35.725Y389.937I35.724993J379.937007
28N37G1X39.725Y389.937
29N38G2X49.725Y379.937I39.725007J379.937007
30N39G1X49.725Y333.931
31N40G2X39.725Y323.931I39.725007J333.930993
32N41G1X35.725Y323.931
33N42G2X25.725Y333.931I35.724993J333.930993
34N43G1X25.725Y356.934
35M5
36N44G40
37N45G0X10Y415
38N46G10S1
39M4
40N47G1X8.762563Y418.5
41N48G42
42N49G2X10Y420.25I10J418.9375
43N50G10S0
44N51G1X15.25Y420.25
45N52X15.25Y389.687
46N53X4.75Y389.687
47N54X4.75Y420.25
48N55X10Y420.25
49M5
50N56G40
51N57G0X69Y395
52N58G10S1
53M4
54N59G1X63.666667Y393.114382
55N60G42
56N61G2X61Y395I63J395
57N62G10S0
58N63G2X70Y404I70J395
59N64G1X85Y404
60N65G2X85Y386I85J395
61N66G1X70Y386
62N67G2X61Y395I70J395
63M5
64N68G40
65N69G0X71.716083Y481.477089
66N70G10S2
67M4
68N71G2X78.144654Y487.90566I78.144654J481.477089
69N72G1X84.573226Y487.90566
70N73G2X91.001797Y481.477089I84.573226J481.477089
71N74G1X91.001797Y479.334232
72N75G2X88.77098Y474.466418I84.572644J479.335502
73N76G1X71.716083Y457.90566
74N77X91.001797Y457.90566
75M5
76N78G0X101.716083Y472.90566
77N79G10S2
78M4
79N80G2X95.287511Y479.334232I101.716083J479.334232
80N81G1X95.287511Y481.477089
81N82G2X101.716083Y487.90566I101.716083J481.477089
82N83G1X108.144654Y487.90566
83N84G2X114.573226Y481.477089I108.144654J481.477089
84N85G1X114.573226Y479.334232
85N86G2X108.144654Y472.90566I108.144654J479.334232
86N87G1X101.716083Y472.90566
87N88G3X95.287511Y466.477089I101.716083J466.477089
88N89G1X95.287511Y464.334232
89N90G3X101.716083Y457.90566I101.716083J464.334232
90N91G1X108.144654Y457.90566
91N92G3X114.573226Y464.334232I108.144654J464.334232
92N93G1X114.573226Y466.477089
93N94G3X108.144654Y472.90566I108.144654J466.477089
94M5
95N95G0X78.04Y510
96N96G10S1
97M4
98N97G1X74.54Y508.762563
99N98G42
100N99G2X72.79Y510I74.1025J510
101N100G10S0
102N101G1X72.79Y515.25
103N102X89.527Y515.25
104N103X89.527Y504.75
105N104X72.79Y504.75
106N105X72.79Y510
107M5
108N106G40
109N107G0X140Y495.132
110N108G10S1
111M4
112N109G1X136.333333Y493.835638
113N110G42
114N111G2X134.5Y495.132I135.875J495.132
115N112G10S0
116N113G2X140Y500.632I140J495.132
117N114G1X150Y500.632
118N115G2X150Y489.632I150J495.132
119N116G1X140Y489.632
120N117G2X134.5Y495.132I140J495.132
121M5
122N118G40
123N119G0X140Y445.132
124N120G10S1
125M4
126N121G1X136.333333Y443.835638
127N122G42
128N123G2X134.5Y445.132I135.875J445.132
129N124G10S0
130N125G2X140Y450.632I140J445.132
131N126G1X150Y450.632
132N127G2X150Y439.632I150J445.132
133N128G1X140Y439.632
134N129G2X134.5Y445.132I140J445.132
135M5
136N130G40
137N131G0X190Y495.132
138N132G10S1
139M4
140N133G1X186.333333Y493.835638
141N134G42
142N135G2X184.5Y495.132I185.875J495.132
143N136G10S0
144N137G2X190Y500.632I190J495.132
145N138G1X200Y500.632
146N139G2X200Y489.632I200J495.132
147N140G1X190Y489.632
148N141G2X184.5Y495.132I190J495.132
149M5
150N142G40
151N143G0X255.723Y510
152N144G10S1
153M4
154N145G1X252.223Y508.762563
155N146G42
156N147G2X250.473Y510I251.7855J510
157N148G10S0
158N149G1X250.473Y515.25
159N150X267.21Y515.25
160N151X267.21Y504.75
161N152X250.473Y504.75
162N153X250.473Y510
163M5
164N154G40
165N155G0X190Y445.132
166N156G10S1
167M4
168N157G1X186.333333Y443.835638
169N158G42
170N159G2X184.5Y445.132I185.875J445.132
171N160G10S0
172N161G2X190Y450.632I190J445.132
173N162G1X200Y450.632
174N163G2X200Y439.632I200J445.132
175N164G1X190Y439.632
176N165G2X184.5Y445.132I190J445.132
177M5
178N166G40
179N167G0X259Y395
180N168G10S1
181M4
182N169G1X253.666667Y393.114382
183N170G42
184N171G2X251Y395I253J395
185N172G10S0
186N173G2X269Y395I260J395
187N174X251Y395I260J395
188M5
189N175G40
190N176G0X330Y415
191N177G10S1
192M4
193N178G1X328.762563Y418.5
194N179G42
195N180G2X330Y420.25I330J418.9375
196N181G10S0
197N182G1X335.25Y420.25
198N183X335.25Y389.687
199N184X324.75Y389.687
200N185X324.75Y420.25
201N186X330Y420.25
202M5
203N187G40
204N188G0X298.275Y356.934
205N189G10S1
206M4
207N190G1X292.941667Y355.048382
208N191G42
209N192G2X290.275Y356.934I292.275J356.934
210N193G10S0
211N194G1X290.275Y379.937
212N195G2X300.275Y389.937I300.274993J379.937007
213N196G1X304.275Y389.937
214N197G2X314.275Y379.937I304.275007J379.937007
215N198G1X314.275Y333.931
216N199G2X304.275Y323.931I304.275007J333.930993
217N200G1X300.275Y323.931
218N201G2X290.275Y333.931I300.274993J333.930993
219N202G1X290.275Y356.934
220M5
221N203G40
222N204G0X330Y348.994
223N205G10S1
224M4
225N206G1X328.762563Y352.494
226N207G42
227N208G2X330Y354.244I330J352.9315
228N209G10S0
229N210G1X335.25Y354.244
230N211X335.25Y323.681
231N212X324.75Y323.681
232N213X324.75Y354.244
233N214X330Y354.244
234M5
235N215G40
236N216G0X302.667Y166.152
237N217G10S1
238M4
239N218G1X297.333667Y164.266382
240N219G42
241N220G2X294.667Y166.152I296.667J166.152
242N221G10S0
243N222G2X324.667Y166.152I309.667J166.152
244N223X294.667Y166.152I309.667J166.152
245M5
246N224G40
247N225G0X330Y153.731
248N226G10S1
249M4
250N227G1X328.762563Y157.231
251N228G42
252N229G2X330Y158.981I330J157.6685
253N230G10S0
254N231G1X335.25Y158.981
255N232X335.25Y112.75
256N233X324.75Y112.75
257N234X324.75Y158.981
258N235X330Y158.981
259M5
260N236G40
261N237G0X330Y28.168
262N238G10S1
263M4
264N239G1X331.237437Y24.668
265N240G42
266N241G2X330Y22.918I330J24.2305
267N242G10S0
268N243G1X324.75Y22.918
269N244X324.75Y52.29
270N245X335.25Y52.29
271N246X335.25Y22.918
272N247X330Y22.918
273M5
274N248G40
275N249G0X259Y50
276N250G10S1
277M4
278N251G1X253.666667Y48.114382
279N252G42
280N253G2X251Y50I253J50
281N254G10S0
282N255G2X269Y50I260J50
283N256X251Y50I260J50
284M5
285N257G40
286N258G0X69Y50
287N259G10S1
288M4
289N260G1X63.666667Y48.114382
290N261G42
291N262G2X61Y50I63J50
292N263G10S0
293N264G2X70Y59I70J50
294N265G1X85Y59
295N266G2X85Y41I85J50
296N267G1X70Y41
297N268G2X61Y50I70J50
298M5
299N269G40
300N270G0X10Y28.168
301N271G10S1
302M4
303N272G1X11.237437Y24.668
304N273G42
305N274G2X10Y22.918I10J24.2305
306N275G10S0
307N276G1X4.75Y22.918
308N277X4.75Y52.29
309N278X15.25Y52.29
310N279X15.25Y22.918
311N280X10Y22.918
312M5
313N281G40
314N282G0X10Y153.731
315N283G10S1
316M4
317N284G1X8.762563Y157.231
318N285G42
319N286G2X10Y158.981I10J157.6685
320N287G10S0
321N288G1X15.25Y158.981
322N289X15.25Y112.75
323N290X4.75Y112.75
324N291X4.75Y158.981
325N292X10Y158.981
326M5
327N293G40
328N294G0X23.333Y166.152
329N295G10S1
330M4
331N296G1X17.999667Y164.266382
332N297G42
333N298G2X15.333Y166.152I17.333J166.152
334N299G10S0
335N300G2X45.333Y166.152I30.333J166.152
336N301X15.333Y166.152I30.333J166.152
337M5
338N302G40
339N303G0X52Y260
340N304G10S1
341M4
342N305G1X57.333333Y261.885618
343N306G42
344N307G2X60Y260I58J260
345N308G10S0
346N309G1X60Y216
347N310G2X54Y210I54.000004J215.999996
348N311G1X6Y210
349N312G2X0Y216I5.999996J215.999996
350N313G1X0Y10
351N314G3X10Y0I9.999993J9.999993
352N315G1X135Y0
353N316G3X145Y10I135.000007J9.999993
354N317G1X145Y30
355N318G2X155Y40I154.999993J30.000007
356N319G1X185Y40
357N320G2X195Y30I185.000007J30.000007
358N321G1X195Y10
359N322G3X205Y0I204.999993J9.999993
360N323G1X330Y0
361N324G3X340Y10I330.000007J9.999993
362N325G1X340Y216
363N326G2X334Y210I334.000004J215.999996
364N327G1X286Y210
365N328G2X280Y216I285.999996J215.999996
366N329G1X280Y307
367N330G2X286Y313I285.999996J307.000004
368N331G1X334Y313
369N332G2X340Y307I334.000004J307.000004
370N333G1X340Y436
371N334G2X334Y430I334.000004J435.999996
372N335G1X286Y430
373N336G2X280Y436I285.999996J435.999996
374N337G1X280Y510
375N338G3X270Y520I270.000007J510.000007
376N339G1X70Y520
377N340G3X60Y510I69.999993J510.000007
378N341G1X60Y436
379N342G2X54Y430I54.000004J435.999996
380N343G1X6Y430
381N344G2X0Y436I5.999996J435.999996
382N345G1X0Y307
383N346G2X6Y313I5.999996J307.000004
384N347G1X54Y313
385N348G2X60Y307I54.000004J307.000004
386N349G1X60Y260
387M5
388N350G40
389(Part End)
390N3G52X364.750000Y376.000000L2C0.000000
391(Part code="550_01_00_013___10__1")
392N352G28X146.742641Y96.742641L2P1
393N353G0X20.495263Y43.712331
394N354G10S2
395M4
396N355G1X20.495263Y53.712331
397N356X24.066691Y53.712331
398N357G2X27.63812Y50.140902I24.066691J50.140902
399N358G1X27.63812Y47.28376
400N359G2X24.066691Y43.712331I24.066691J47.28376
401N360G1X20.495263Y43.712331
402M5
403N361G0X36.209548Y52.998045
404N362G10S2
405M4
406N363G3X34.066691Y53.712331I34.275901J50.768531
407N364G1X31.209548Y53.712331
408N365G3X29.066691Y51.569474I31.209548J51.569474
409N366G1X29.066691Y50.855188
410N367G3X31.209548Y48.712331I31.209548J50.855188
411N368G1X34.066691Y48.712331
412N369G2X36.209548Y46.569474I34.066691J46.569474
413N370G1X36.209548Y45.855188
414N371G2X34.066691Y43.712331I34.066691J45.855188
415N372G1X31.209548Y43.712331
416N373G2X29.066691Y44.426617I31.000339J46.656131
417M5
418N374G0X44.066691Y53.712331
419N375G10S2
420M4
421N376G1X37.63812Y53.712331
422N377X37.63812Y50.140902
423N378X41.209548Y50.140902
424N379G2X44.066691Y47.28376I41.209548J47.28376
425N380G1X44.066691Y46.569474
426N381G2X41.209548Y43.712331I41.209548J46.569474
427N382G1X39.780977Y43.712331
428N383G2X37.63812Y44.426617I39.571767J46.656131
429M5
430N384G0X51.923834Y53.712331
431N385G10S2
432M4
433N386G1X45.495263Y53.712331
434N387X45.495263Y50.140902
435N388X49.066691Y50.140902
436N389G2X51.923834Y47.28376I49.066691J47.28376
437N390G1X51.923834Y46.569474
438N391G2X49.066691Y43.712331I49.066691J46.569474
439N392G1X47.63812Y43.712331
440N393G2X45.495263Y44.426617I47.42891J46.656131
441M5
442N394G0X53.352405Y46.569474
443N395G10S2
444M4
445N396G1X53.352405Y50.855188
446N397G2X56.209548Y53.712331I56.209548J50.855188
447N398G1X56.923834Y53.712331
448N399G2X59.780977Y50.855188I56.923834J50.855188
449N400G1X59.780977Y46.569474
450N401G2X56.923834Y43.712331I56.923834J46.569474
451N402X53.352405Y46.569474I56.566691J46.926617
452M5
453N403G0X61.209548Y43.712331
454N404G10S2
455M4
456N405G1X65.495263Y43.712331
457M5
458N406G0X66.923834Y46.569474
459N407G10S2
460M4
461N408G1X66.923834Y50.855188
462N409G2X69.780977Y53.712331I69.780977J50.855188
463N410G1X70.495263Y53.712331
464N411G2X73.352405Y50.855188I70.495263J50.855188
465N412G1X73.352405Y46.569474
466N413G2X70.495263Y43.712331I70.495263J46.569474
467N414X66.923834Y46.569474I70.13812J46.926617
468M5
469N415G0X76.209548Y49.426617
470N416G10S2
471M4
472N417G1X79.066691Y53.712331
473N418X79.066691Y43.712331
474M5
475N419G0X82.63812Y43.712331
476N420G10S2
477M4
478N421G1X86.923834Y43.712331
479M5
480N422G0X88.352405Y46.569474
481N423G10S2
482M4
483N424G1X88.352405Y50.855188
484N425G2X91.209548Y53.712331I91.209548J50.855188
485N426G1X91.923834Y53.712331
486N427G2X94.780977Y50.855188I91.923834J50.855188
487N428G1X94.780977Y46.569474
488N429G2X91.923834Y43.712331I91.923834J46.569474
489N430X88.352405Y46.569474I91.566691J46.926617
490M5
491N431G0X96.209548Y46.569474
492N432G10S2
493M4
494N433G1X96.209548Y50.855188
495N434G2X99.066691Y53.712331I99.066691J50.855188
496N435G1X99.780977Y53.712331
497N436G2X102.63812Y50.855188I99.780977J50.855188
498N437G1X102.63812Y46.569474
499N438G2X99.780977Y43.712331I99.780977J46.569474
500N439X96.209548Y46.569474I99.423834J46.926617
501M5
502N440G0X104.066691Y43.712331
503N441G10S2
504M4
505N442G1X108.352405Y43.712331
506M5
507N443G0X109.780977Y46.569474
508N444G10S2
509M4
510N445G1X109.780977Y50.855188
511N446G2X112.63812Y53.712331I112.63812J50.855188
512N447G1X113.352405Y53.712331
513N448G2X116.209548Y50.855188I113.352405J50.855188
514N449G1X116.209548Y46.569474
515N450G2X113.352405Y43.712331I113.352405J46.569474
516N451X109.780977Y46.569474I112.995263J46.926617
517M5
518N452G0X119.066691Y49.426617
519N453G10S2
520M4
521N454G1X121.923834Y53.712331
522N455X121.923834Y43.712331
523M5
524N456G0X125.495263Y51.569474
525N457G10S2
526M4
527N458G2X127.63812Y53.712331I127.63812J51.569474
528N459G1X129.780977Y53.712331
529N460G2X131.923834Y51.569474I129.780977J51.569474
530N461G1X131.923834Y50.855188
531N462G2X129.780977Y48.712331I129.780977J50.855188
532N463G1X128.352405Y48.712331
533N464X129.780977Y48.712331
534N465G2X131.923834Y46.569474I129.780977J46.569474
535N466G1X131.923834Y45.855188
536N467G2X129.780977Y43.712331I129.780977J45.855188
537N468G1X127.63812Y43.712331
538N469G2X125.495263Y45.855188I127.63812J45.855188
539M5
540N470G0X22.217641Y15
541N471G10S2
542M4
543N472G1X22.267641
544M5
545N473G0X29.217641Y20
546N474G10S2
547M4
548N475G1X29.267641
549M5
550N476G0X119.217641
551N477G10S2
552M4
553N478G1X119.267641
554M5
555N479G0X126.217641Y15
556N480G10S2
557M4
558N481G1X126.267641
559M5
560N482G0X126.217641Y85
561N483G10S2
562M4
563N484G1X126.267641
564M5
565N485G0X119.217641Y80
566N486G10S2
567M4
568N487G1X119.267641
569M5
570N488G0X29.217641
571N489G10S2
572M4
573N490G1X29.267641
574M5
575N491G0X22.217641Y85
576N492G10S2
577M4
578N493G1X22.267641
579M5
580N494G0X0Y96.742641
581N495G10S0
582M4
583N496G1X3.346065Y95.846065
584N497G42
585N498G2X4.242641Y92.5I2.828427J93.914214
586N499G1X1.742641Y90
587N500X1.742641Y0
588N501X146.742641
589N502X146.742641Y90
590N503X141.742641Y95
591N504X6.742641
592N505X4.242641Y92.5
593M5
594N506G40
595(Part End)
596N4G52X626.240000Y17.750000L3C90.000000
597(Part code="114___10__2")
598N508G28X40Y50L3P1
599N509G0X19Y30
600N510G10S1
601N511G42
602M14
603M4
604N512G2X15I17J30
605N513X25I20
606N514X15
607M5
608M15
609N515G40
610N516G0X13.59434Y14.192273
611N517G10S2
612M4
613N518G1X5.59434Y14.192273
614N519X5.59434Y17.906559
615N520G2X9.59434Y17.906559I7.59434J17.906559
616N521G1X9.59434Y14.192273
617M5
618N522G0X9.022911Y22.192273
619N523G10S2
620M4
621N524G1X5.59434Y24.477987
622N525X13.59434Y24.477987
623M5
624N526G0X9.022911Y28.477987
625N527G10S2
626M4
627N528G1X5.59434Y30.763702
628N529X13.59434Y30.763702
629M5
630N530G0X13.59434Y37.620845
631N531G10S2
632M4
633N532G1X5.59434Y37.620845
634N533X11.308625Y33.620845
635N534X11.308625Y38.763702
636M5
637N535G0X4.071Y4
638N536G10S1
639M4
640N537G1X2.338949Y7
641N538G42
642N539G2X4.071Y10I4.071J8
643N540G10S0
644N541G1X8.142
645N542Y0
646N543X33.142
647N544X33.142Y10
648N545X40
649N546Y30
650N547G3X0I20J30
651N548G1Y10
652N549X4.071
653M5
654N550G40
655(Part End)
656N5G52X626.490000Y77.750000L3C90.000000
657(Part code="114___10__2")
658N508G28X40Y50L3P1
659N509G0X19Y30
660N510G10S1
661N511G42
662M14
663M4
664N512G2X15I17J30
665N513X25I20
666N514X15
667M5
668M15
669N515G40
670N516G0X13.59434Y14.192273
671N517G10S2
672M4
673N518G1X5.59434Y14.192273
674N519X5.59434Y17.906559
675N520G2X9.59434Y17.906559I7.59434J17.906559
676N521G1X9.59434Y14.192273
677M5
678N522G0X9.022911Y22.192273
679N523G10S2
680M4
681N524G1X5.59434Y24.477987
682N525X13.59434Y24.477987
683M5
684N526G0X9.022911Y28.477987
685N527G10S2
686M4
687N528G1X5.59434Y30.763702
688N529X13.59434Y30.763702
689M5
690N530G0X13.59434Y37.620845
691N531G10S2
692M4
693N532G1X5.59434Y37.620845
694N533X11.308625Y33.620845
695N534X11.308625Y38.763702
696M5
697N535G0X4.071Y4
698N536G10S1
699M4
700N537G1X2.338949Y7
701N538G42
702N539G2X4.071Y10I4.071J8
703N540G10S0
704N541G1X8.142
705N542Y0
706N543X33.142
707N544X33.142Y10
708N545X40
709N546Y30
710N547G3X0I20J30
711N548G1Y10
712N549X4.071
713M5
714N550G40
715(Part End)
716N6G52X626.750000Y137.750000L3C90.000000
717(Part code="114___10__2")
718N508G28X40Y50L3P1
719N509G0X19Y30
720N510G10S1
721N511G42
722M14
723M4
724N512G2X15I17J30
725N513X25I20
726N514X15
727M5
728M15
729N515G40
730N516G0X13.59434Y14.192273
731N517G10S2
732M4
733N518G1X5.59434Y14.192273
734N519X5.59434Y17.906559
735N520G2X9.59434Y17.906559I7.59434J17.906559
736N521G1X9.59434Y14.192273
737M5
738N522G0X9.022911Y22.192273
739N523G10S2
740M4
741N524G1X5.59434Y24.477987
742N525X13.59434Y24.477987
743M5
744N526G0X9.022911Y28.477987
745N527G10S2
746M4
747N528G1X5.59434Y30.763702
748N529X13.59434Y30.763702
749M5
750N530G0X13.59434Y37.620845
751N531G10S2
752M4
753N532G1X5.59434Y37.620845
754N533X11.308625Y33.620845
755N534X11.308625Y38.763702
756M5
757N535G0X4.071Y4
758N536G10S1
759M4
760N537G1X2.338949Y7
761N538G42
762N539G2X4.071Y10I4.071J8
763N540G10S0
764N541G1X8.142
765N542Y0
766N543X33.142
767N544X33.142Y10
768N545X40
769N546Y30
770N547G3X0I20J30
771N548G1Y10
772N549X4.071
773M5
774N550G40
775(Part End)
776N7G52X621.280000Y197.750000L3C90.000000
777(Part code="114___10__2")
778N508G28X40Y50L3P1
779N509G0X19Y30
780N510G10S1
781N511G42
782M14
783M4
784N512G2X15I17J30
785N513X25I20
786N514X15
787M5
788M15
789N515G40
790N516G0X13.59434Y14.192273
791N517G10S2
792M4
793N518G1X5.59434Y14.192273
794N519X5.59434Y17.906559
795N520G2X9.59434Y17.906559I7.59434J17.906559
796N521G1X9.59434Y14.192273
797M5
798N522G0X9.022911Y22.192273
799N523G10S2
800M4
801N524G1X5.59434Y24.477987
802N525X13.59434Y24.477987
803M5
804N526G0X9.022911Y28.477987
805N527G10S2
806M4
807N528G1X5.59434Y30.763702
808N529X13.59434Y30.763702
809M5
810N530G0X13.59434Y37.620845
811N531G10S2
812M4
813N532G1X5.59434Y37.620845
814N533X11.308625Y33.620845
815N534X11.308625Y38.763702
816M5
817N535G0X4.071Y4
818N536G10S1
819M4
820N537G1X2.338949Y7
821N538G42
822N539G2X4.071Y10I4.071J8
823N540G10S0
824N541G1X8.142
825N542Y0
826N543X33.142
827N544X33.142Y10
828N545X40
829N546Y30
830N547G3X0I20J30
831N548G1Y10
832N549X4.071
833M5
834N550G40
835(Part End)
836N8G52X651.410000Y257.750000L3C90.000000
837(Part code="114___10__2")
838N508G28X40Y50L3P1
839N509G0X19Y30
840N510G10S1
841N511G42
842M14
843M4
844N512G2X15I17J30
845N513X25I20
846N514X15
847M5
848M15
849N515G40
850N516G0X13.59434Y14.192273
851N517G10S2
852M4
853N518G1X5.59434Y14.192273
854N519X5.59434Y17.906559
855N520G2X9.59434Y17.906559I7.59434J17.906559
856N521G1X9.59434Y14.192273
857M5
858N522G0X9.022911Y22.192273
859N523G10S2
860M4
861N524G1X5.59434Y24.477987
862N525X13.59434Y24.477987
863M5
864N526G0X9.022911Y28.477987
865N527G10S2
866M4
867N528G1X5.59434Y30.763702
868N529X13.59434Y30.763702
869M5
870N530G0X13.59434Y37.620845
871N531G10S2
872M4
873N532G1X5.59434Y37.620845
874N533X11.308625Y33.620845
875N534X11.308625Y38.763702
876M5
877N535G0X4.071Y4
878N536G10S1
879M4
880N537G1X2.338949Y7
881N538G42
882N539G2X4.071Y10I4.071J8
883N540G10S0
884N541G1X8.142
885N542Y0
886N543X33.142
887N544X33.142Y10
888N545X40
889N546Y30
890N547G3X0I20J30
891N548G1Y10
892N549X4.071
893M5
894N550G40
895(Part End)
896N9G52X484.430000Y497.750000L3C90.000000
897(Part code="114___10__2")
898N508G28X40Y50L3P1
899N509G0X19Y30
900N510G10S1
901N511G42
902M14
903M4
904N512G2X15I17J30
905N513X25I20
906N514X15
907M5
908M15
909N515G40
910N516G0X13.59434Y14.192273
911N517G10S2
912M4
913N518G1X5.59434Y14.192273
914N519X5.59434Y17.906559
915N520G2X9.59434Y17.906559I7.59434J17.906559
916N521G1X9.59434Y14.192273
917M5
918N522G0X9.022911Y22.192273
919N523G10S2
920M4
921N524G1X5.59434Y24.477987
922N525X13.59434Y24.477987
923M5
924N526G0X9.022911Y28.477987
925N527G10S2
926M4
927N528G1X5.59434Y30.763702
928N529X13.59434Y30.763702
929M5
930N530G0X13.59434Y37.620845
931N531G10S2
932M4
933N532G1X5.59434Y37.620845
934N533X11.308625Y33.620845
935N534X11.308625Y38.763702
936M5
937N535G0X4.071Y4
938N536G10S1
939M4
940N537G1X2.338949Y7
941N538G42
942N539G2X4.071Y10I4.071J8
943N540G10S0
944N541G1X8.142
945N542Y0
946N543X33.142
947N544X33.142Y10
948N545X40
949N546Y30
950N547G3X0I20J30
951N548G1Y10
952N549X4.071
953M5
954N550G40
955(Part End)
956N10G52X15.040000Y544.590000L4C0.000000
957(Part code="33___10__1")
958N552G28X184.422Y120L4P1
959N553G0X57.186Y100
960N554G10S2
961M4
962N555G1X57.236
963M5
964N556G0X80.888952Y108.586119
965N557G10S2
966M4
967N558G2X84.103237Y111.800404I84.103237J108.586119
968N559G1X87.317523Y111.800404
969N560G2X90.531809Y108.586119I87.317523J108.586119
970N561G1X90.531809Y107.51469
971N562G2X87.317523Y104.300404I87.317523J107.51469
972N563G1X85.174666Y104.300404
973N564X87.317523Y104.300404
974N565G2X90.531809Y101.086119I87.317523J101.086119
975N566G1X90.531809Y100.01469
976N567G2X87.317523Y96.800404I87.317523J100.01469
977N568G1X84.103237Y96.800404
978N569G2X80.888952Y100.01469I84.103237J100.01469
979M5
980N570G0X92.674666Y108.586119
981N571G10S2
982M4
983N572G2X95.888952Y111.800404I95.888952J108.586119
984N573G1X99.103237Y111.800404
985N574G2X102.317523Y108.586119I99.103237J108.586119
986N575G1X102.317523Y107.51469
987N576G2X99.103237Y104.300404I99.103237J107.51469
988N577G1X96.96038Y104.300404
989N578X99.103237Y104.300404
990N579G2X102.317523Y101.086119I99.103237J101.086119
991N580G1X102.317523Y100.01469
992N581G2X99.103237Y96.800404I99.103237J100.01469
993N582G1X95.888952Y96.800404
994N583G2X92.674666Y100.01469I95.888952J100.01469
995M5
996N584G0X127.186Y100
997N585G10S2
998M4
999N586G1X127.236
1000M5
1001N587G0X127.186Y20
1002N588G10S2
1003M4
1004N589G1X127.236
1005M5
1006N590G0X57.186
1007N591G10S2
1008M4
1009N592G1X57.236
1010M5
1011N593G0X36.124965Y3.320287
1012N594G10S0
1013M4
1014N595G1X36.651566Y6.744129
1015N596G42
1016N597G2X39.88Y8I38.628322J6.440096
1017N598G1X49.85Y0
1018N599X134.572
1019N600X184.422Y40
1020N601Y80
1021N602X134.7Y120
1022N603X49.722
1023N604X0Y80
1024N605Y40
1025N606X39.88Y8
1026M5
1027N607G40
1028(Part End)
1029N11G52X306.720000Y495.950000L5C0.000000
1030(Part code="13___10__4")
1031N609G28X118Y40L5P1
1032N610G0X37.384762Y22.744081
1033N611G10S2
1034M4
1035N612G1X45.95619Y35.601224
1036N613X45.95619Y5.601224
1037M5
1038N614G0X56.670476Y29.172652
1039N615G10S2
1040M4
1041N616G2X63.099048Y35.601224I63.099048J29.172652
1042N617G1X69.527619Y35.601224
1043N618G2X75.95619Y29.172652I69.527619J29.172652
1044N619G1X75.95619Y27.029795
1045N620G2X69.527619Y20.601224I69.527619J27.029795
1046N621G1X65.241905Y20.601224
1047N622X69.527619Y20.601224
1048N623G2X75.95619Y14.172652I69.527619J14.172652
1049N624G1X75.95619Y12.029795
1050N625G2X69.527619Y5.601224I69.527619J12.029795
1051N626G1X63.099048Y5.601224
1052N627G2X56.670476Y12.029795I63.099048J12.029795
1053M5
1054N628G0X5Y33
1055N629G10S1
1056M4
1057N630G1X6.885618Y27.666667
1058N631G42
1059N632G2X5Y25I5J27
1060N633G10S0
1061N634G1X0
1062N635Y10
1063N636X10
1064N637Y0
1065N638X108
1066N639Y10
1067N640X118
1068N641Y25
1069N642X108
1070N643Y40
1071N644X10
1072N645Y25
1073N646X5
1074M5
1075N647G40
1076(Part End)
1077N12G52X566.890000Y16.000000L6C90.000000
1078(Part code="22___10__1")
1079N649G28X189Y200L6P1
1080N650G0X77Y62.714
1081N651G10S1
1082M4
1083N652G1X73.333333Y61.417638
1084N653G42
1085N654G2X71.5Y62.714I72.875J62.714
1086N655G10S0
1087N656G2X77Y68.214I77
1088N657G1X81
1089N658G2Y57.214I81
1090N659G1X77
1091N660G2X71.5Y62.714I77
1092M5
1093N661G40
1094N662G0X77Y12.714
1095N663G10S1
1096M4
1097N664G1X73.333333Y14.010362
1098N665G41
1099N666G3X71.5Y12.714I72.875J12.714
1100N667G10S0
1101N668G3X77Y7.214I77J12.714
1102N669G1X81Y7.214
1103N670G3Y18.214I81J12.714
1104N671G1X77
1105N672G3X71.5Y12.714I77J12.714
1106M5
1107N673G40
1108N674G0X27Y12.714
1109N675G10S1
1110M4
1111N676G1X23.333333Y11.417638
1112N677G42
1113N678G2X21.5Y12.714I22.875J12.714
1114N679G10S0
1115N680G2X27Y18.214I27J12.714
1116N681G1X31
1117N682G2Y7.214I31J12.714
1118N683G1X27Y7.214
1119N684G2X21.5Y12.714I27J12.714
1120M5
1121N685G40
1122N686G0X27Y62.714
1123N687G10S1
1124M4
1125N688G1X23.333333Y61.417638
1126N689G42
1127N690G2X21.5Y62.714I22.875J62.714
1128N691G10S0
1129N692G2X27Y68.214I27
1130N693G1X31
1131N694G2Y57.214I31
1132N695G1X27
1133N696G2X21.5Y62.714I27
1134M5
1135N697G40
1136N698G0X22.379605Y186.433064
1137N699G10S2
1138M4
1139N700G2X28.808176Y192.861635I28.808176J186.433064
1140N701G1X35.236748Y192.861635
1141N702G2X41.665319Y186.433064I35.236748J186.433064
1142N703G1X41.665319Y184.290207
1143N704G2X39.434502Y179.422392I35.236166J184.291477
1144N705G1X22.379605Y162.861635
1145N706X41.665319Y162.861635
1146M5
1147N707G0X45.951033Y186.433064
1148N708G10S2
1149M4
1150N709G2X52.379605Y192.861635I52.379605J186.433064
1151N710G1X58.808176Y192.861635
1152N711G2X65.236748Y186.433064I58.808176J186.433064
1153N712G1X65.236748Y184.290207
1154N713G2X63.005931Y179.422392I58.807594J184.291477
1155N714G1X45.951033Y162.861635
1156N715X65.236748Y162.861635
1157M5
1158N716G0X6Y133.644
1159N717G10S1
1160M4
1161N718G1X7.885618Y128.310667
1162N719G42
1163N720G2X6Y125.644I6J127.644
1164N721G10S0
1165N722G1X0
1166N723Y74.311
1167N724X12
1168N725Y49.714
1169N726X0
1170N727Y12.714
1171N728X12Y12.714
1172N729Y0
1173N730X177
1174N731Y12.714
1175N732X189Y12.714
1176N733Y49.714
1177N734X177
1178N735Y74.311
1179N736X189
1180N737Y125.644
1181N738X177
1182N739Y145.322
1183N740X189
1184N741Y180.322
1185N742X177
1186N743Y200
1187N744X12
1188N745Y180.322
1189N746X0
1190N747Y145.322
1191N748X12
1192N749Y125.644
1193N750X6
1194M5
1195N751G40
1196(Part End)
1197N13G52X210.230000Y321.610000L7C0.000000
1198(Part code="108___10__1")
1199N753G28X439.5Y356.294L7P1
1200N754G0X357.69Y273.4785
1201N755G10S1
1202M4
1203N756G1X354.69Y271.746449
1204N757G42
1205N758G2X351.69Y273.4785I353.69J273.4785
1206N759G10S0
1207N760G1Y299.021
1208N761G2X361.69Y309.021I361.689993J299.021007
1209N762G1X391.592Y309.021
1210N763G2X401.592Y299.021I391.592007J299.021007
1211N764G1Y247.936
1212N765G2X391.592Y237.936I391.592007J247.935993
1213N766G1X381.087Y237.936
1214N767G2X373.5Y241.422I381.087413J247.936148
1215N768G1X354.103Y264.014
1216N769G2X351.69Y270.528I361.689511J270.528221
1217N770G1Y273.4785
1218M5
1219N771G40
1220N772G0X228.5Y259.294
1221N773G10S1
1222M14
1223M4
1224N774G1X223.5
1225N775G42
1226N776G2X233.5I228.5J259.294
1227N777X223.5
1228M5
1229M15
1230N778G40
1231N779G0X228.5Y289.294
1232N780G10S1
1233M14
1234M4
1235N781G1X223.5
1236N782G42
1237N783G2X233.5J289.294
1238N784X223.5
1239M5
1240M15
1241N785G40
1242N786G0X228.5Y319.294
1243N787G10S1
1244M14
1245M4
1246N788G1X223.5
1247N789G42
1248N790G2X233.5J319.294
1249N791X223.5
1250M5
1251M15
1252N792G40
1253N793G0X195.5Y323.294
1254N794G10S1
1255M4
1256N795G1X193.767949Y326.294
1257N796G42
1258N797G2X195.5Y329.294I195.5J327.294
1259N798G10S0
1260N799G1X215.5
1261N800Y249.294
1262N801X175.5Y249.294
1263N802Y329.294
1264N803X195.5
1265M5
1266N804G40
1267N805G0X162.5Y319.294
1268N806G10S1
1269M14
1270M4
1271N807G1X157.5
1272N808G42
1273N809G2X167.5I162.5J319.294
1274N810X157.5
1275M5
1276M15
1277N811G40
1278N812G0X162.5Y289.294
1279N813G10S1
1280M14
1281M4
1282N814G1X157.5
1283N815G42
1284N816G2X167.5J289.294
1285N817X157.5
1286M5
1287M15
1288N818G40
1289N819G0X31.983Y337.9
1290N820G10S1
1291M14
1292M4
1293N821G1X26.983
1294N822G42
1295N823G2X36.983I31.983J337.9
1296N824X26.983I31.983
1297M5
1298M15
1299N825G40
1300N826G0X18.222268Y291.182964
1301N827G10S2
1302M4
1303N828G1X8.222268Y291.182964
1304N829X8.222268Y295.825821
1305N830G2X13.222268Y295.825821I10.722268J295.825821
1306N831G1X13.222268Y291.182964
1307M5
1308N832G0X12.507982Y301.182964
1309N833G10S2
1310M4
1311N834G1X8.222268Y304.040107
1312N835X18.222268Y304.040107
1313M5
1314N836G0X15.365125Y307.611535
1315N837G10S2
1316M4
1317N838G1X11.079411Y307.611535
1318N839G2X8.222268Y310.468678I11.079411J310.468678
1319N840G1X8.222268Y311.182964
1320N841G2X11.079411Y314.040107I11.079411J311.182964
1321N842G1X15.365125Y314.040107
1322N843G2X18.222268Y311.182964I15.365125J311.182964
1323N844X15.365125Y307.611535I15.007982J310.825821
1324M5
1325N845G0X13.222268Y317.611535
1326N846G10S2
1327M4
1328N847G2X11.079411Y315.468678I11.079411J317.611535
1329N848G1X10.365125Y315.468678
1330N849G2X8.222268Y317.611535I10.365125J317.611535
1331N850G1X8.222268Y319.754392
1332N851G2X10.365125Y321.897249I10.365125J319.754392
1333N852G1X11.079411Y321.897249
1334N853G2X13.222268Y319.754392I11.079411J319.754392
1335N854G1X13.222268Y317.611535
1336N855G3X15.365125Y315.468678I15.365125J317.611535
1337N856G1X16.079411Y315.468678
1338N857G3X18.222268Y317.611535I16.079411J317.611535
1339N858G1X18.222268Y319.754392
1340N859G3X16.079411Y321.897249I16.079411J319.754392
1341N860G1X15.365125Y321.897249
1342N861G3X13.222268Y319.754392I15.365125J319.754392
1343M5
1344N862G0X31.983Y260.03
1345N863G10S1
1346M14
1347M4
1348N864G1X26.983
1349N865G42
1350N866G2X36.983I31.983J260.03
1351N867X26.983I31.983
1352M5
1353M15
1354N868G40
1355N869G0X140.5Y270.413
1356N870G10S1
1357M4
1358N871G1X141.943376Y267.913
1359N872G42
1360N873G2X140.5Y265.413I140.5J267.079667
1361N874G10S0
1362N875G1X135.5
1363N876Y326.413
1364N877X145.5
1365N878Y265.413
1366N879X140.5
1367M5
1368N880G40
1369N881G0X162.5Y259.294
1370N882G10S1
1371M14
1372M4
1373N883G1X157.5
1374N884G42
1375N885G2X167.5I162.5J259.294
1376N886X157.5
1377M5
1378M15
1379N887G40
1380N888G0X361.5Y77
1381N889G10S1
1382M14
1383M4
1384N890G1X356.5Y77
1385N891G42
1386N892G2X366.5Y77I361.5J77
1387N893X356.5Y77J77
1388M5
1389M15
1390N894G40
1391N895G0X361.5Y47
1392N896G10S1
1393M14
1394M4
1395N897G1X356.5
1396N898G42
1397N899G2X366.5J47
1398N900X356.5
1399M5
1400M15
1401N901G40
1402N902G0X427.5
1403N903G10S1
1404M14
1405M4
1406N904G1X422.5
1407N905G42
1408N906G2X432.5I427.5
1409N907X422.5
1410M5
1411M15
1412N908G40
1413N909G0X427.5Y77
1414N910G10S1
1415M14
1416M4
1417N911G1X422.5Y77
1418N912G42
1419N913G2X432.5Y77J77
1420N914X422.5Y77J77
1421M5
1422M15
1423N915G40
1424N916G0X427.5Y107
1425N917G10S1
1426M14
1427M4
1428N918G1X422.5Y107
1429N919G42
1430N920G2X432.5Y107J107
1431N921X422.5Y107J107
1432M5
1433M15
1434N922G40
1435N923G0X394.5Y111
1436N924G10S1
1437M4
1438N925G1X392.767949Y114
1439N926G42
1440N927G2X394.5Y117I394.5J115
1441N928G10S0
1442N929G1X414.5Y117
1443N930Y37
1444N931X374.5
1445N932Y117
1446N933X394.5Y117
1447M5
1448N934G40
1449N935G0X361.5Y107
1450N936G10S1
1451M14
1452M4
1453N937G1X356.5Y107
1454N938G42
1455N939G2X366.5Y107I361.5J107
1456N940X356.5Y107J107
1457M5
1458M15
1459N941G40
1460N942G0X343.5Y178.147
1461N943G10S1
1462M4
1463N944G1X346.5Y179.879051
1464N945G42
1465N946G2X349.5Y178.147I347.5J178.147
1466N947G10S0
1467N948G1Y37.706
1468N949G2X346.014Y30.119I339.499852J37.706413
1469N950G1X332.986Y18.932
1470N951G3X329.5Y11.345I339.500148J11.344587
1471N952G1Y0
1472N953X348
1473N954Y10
1474N955X350.912
1475N956X356.735Y15
1476N957X422
1477N958Y0
1478N959X439.5
1479N960Y346.294
1480N961X422
1481N962Y331.294
1482N963X348
1483N964Y346.294
1484N965X329.287
1485N966X329.287Y356.294
1486N967X272.287
1487N968Y346.294
1488N969X216.798
1489N970Y356.294
1490N971X171.008
1491N972Y346.294
1492N973X95.873
1493N974Y356.294
1494N975X12.953
1495N976X12.953Y346.294
1496N977X4.5
1497N978Y333.617
1498N979X0Y333.617
1499N980Y277.617
1500N981X4.5Y277.617
1501N982Y234.294
1502N983X308.34Y234.294
1503N984G2X315.927Y230.808I308.339587J224.293852
1504N985G1X347.087Y194.517
1505N986G2X349.5Y188.003I339.500489J188.002779
1506N987G1Y178.147
1507M5
1508N988G40
1509(Part End)
1510N14G52X365.620000Y215.950000L8C0.000000
1511(Part code="007___10__2")
1512N990G28X230.696Y133.1L8P1
1513N991G0X144.8035Y48.3505
1514N992G10S1
1515M14
1516M4
1517N993G1X139.65
1518N994G42
1519N995G1X139.65Y53.504
1520N996X150.15Y53.504
1521N997X150.15Y43.197
1522N998X139.65Y43.197
1523N999X139.65Y48.3505
1524M5
1525M15
1526N1000G40
1527N1001G0X58.519Y83.4515
1528N1002G10S1
1529M4
1530N1003G1X53.185667Y81.565882
1531N1004G42
1532N1005G2X50.519Y83.4515I52.519J83.4515
1533N1006G10S0
1534N1007G1X50.519Y90.1
1535N1008G2X60.519Y100.1I60.518993J90.100007
1536N1009G1X93.519
1537N1010G2X103.519Y90.1I93.519008J90.100007
1538N1011G1X103.519Y76.803
1539N1012G2X93.519Y66.803I93.519008J76.802993
1540N1013G1X60.519
1541N1014G2X50.519Y76.803I60.518993J76.802993
1542N1015G1X50.519Y83.4515
1543M5
1544N1016G40
1545N1017G0X7.220855Y101.565167
1546N1018G10S2
1547M4
1548N1019G1X7.220855Y121.565167
1549N1020X16.506569Y121.565167
1550N1021G2X16.506569Y111.565167I16.506569J116.565167
1551N1022G1X7.220855Y111.565167
1552M5
1553N1023G0X24.363712Y107.279453
1554N1024G10S2
1555M4
1556N1025G1X24.363712Y115.850882
1557N1026G2X30.077998Y121.565167I30.077998J115.850882
1558N1027G1X31.506569Y121.565167
1559N1028G2X37.220855Y115.850882I31.506569J115.850882
1560N1029G1X37.220855Y107.279453
1561N1030G2X31.506569Y101.565167I31.506569J107.279453
1562N1031X24.363712Y107.279453I30.792283J107.993739
1563M5
1564N1032G0X40.077998Y107.279453
1565N1033G10S2
1566M4
1567N1034G1X40.077998Y115.850882
1568N1035G2X45.792283Y121.565167I45.792283J115.850882
1569N1036G1X47.220855Y121.565167
1570N1037G2X52.935141Y115.850882I47.220855J115.850882
1571N1038G1X52.935141Y107.279453
1572N1039G2X47.220855Y101.565167I47.220855J107.279453
1573N1040X40.077998Y107.279453I46.506569J107.993739
1574M5
1575N1041G0X67.792283Y120.136596
1576N1042G10S2
1577M4
1578N1043G3X63.792283Y121.565167I64.067845J116.022455
1579N1044G1X61.506569Y121.565167
1580N1045G3X55.792283Y115.850882I61.506569J115.850882
1581N1046G1X55.792283Y107.279453
1582N1047G3X61.506569Y101.565167I61.506569J107.279453
1583N1048G1X62.935141Y101.565167
1584N1049G3X68.649426Y107.279453I62.935141J107.279453
1585N1050G1X68.649426Y108.708025
1586N1051G3X62.935141Y114.42231I62.935141J108.708025
1587N1052G1X61.506569Y114.42231
1588N1053G3X55.792283Y108.708025I61.506569J108.708025
1589M5
1590N1054G0X0.407779Y54.278116
1591N1055G10S1
1592M4
1593N1056G1X4.676245Y57.990285
1594N1057G42
1595N1058G2X7.849Y57.2155I5.988695J56.481154
1596N1059G10S0
1597N1060G1X15Y39.1
1598N1061X32.679Y39.1
1599N1062X32.679Y29.1
1600N1063X65.2Y29.1
1601N1064X65.2Y39.1
1602N1065X110.23Y39.1
1603N1066X110.23Y29.1
1604N1067X129.9Y0
1605N1068X129.9Y10
1606N1069X177.9
1607N1070X177.9Y0
1608N1071X210.654Y29.1
1609N1072X210.654Y39.1
1610N1073X230.696Y39.1
1611N1074X230.696Y42.109
1612N1075G3X224.13Y51.501I220.695998J42.109106
1613N1076G1X149.9Y78.641
1614N1077X149.9Y101.033
1615N1078X139.9Y101.033
1616N1079X139.9Y115.806
1617N1080X149.9
1618N1081X149.9Y123.1
1619N1082X128.264
1620N1083X128.264Y133.1
1621N1084X105.2
1622N1085X105.2Y123.1
1623N1086X41.325
1624N1087X41.325Y133.1
1625N1088X18.83
1626N1089X18.83Y123.1
1627N1090X0
1628N1091X0Y79.002
1629N1092G3X0.698Y75.331I9.998027J79.001156
1630N1093G1X7.849Y57.2155
1631M5
1632N1094G40
1633(Part End)
1634N15G99`

function toUnits(mm, pulsesPerMM) {
	return mm
	//return Math.floor((mm * pulsesPerMM) / 4);
}

/** Нормализация угла в интервал [-PI, PI] */
function normalizeAngle(a) {
	while (a > Math.PI) a -= 2 * Math.PI;
	while (a < -Math.PI) a += 2 * Math.PI;
	return a;
}

function makeGcodeParser() {
	let last = { g: undefined, m: undefined, params: {} };
	let base = { X: 0, Y: 0, C: 0 }; // базовые значения из строки перед Part code
	let nextIsFirst = false; 

	return function parseGcodeLine(raw) {
		let s = String(raw).trim();
		s = s.replace(/^\d+\s*/, '');

		const out = { n: undefined, g: undefined, m: undefined, params: {} };

 		const commentMatch = s.match(/\(([^)]*)\)/);
		if (commentMatch) {
			out.comment = commentMatch[1];
			s = s.replace(/\([^)]*\)/g, ' ');

			// Если встретили Part code
			if (/Part code=/i.test(out.comment)) {
				nextIsFirst = true		
			}
		}

		const nMatch = s.match(/N(\d+)/i);
		if (nMatch) out.n = parseInt(nMatch[1], 10);

		// G/M
		const gMatch = s.match(/G(-?\d+(?:\.\d+)?)/i);
		out.g = gMatch ? Number(gMatch[1]) : last.g;
		const mMatch = s.match(/M(-?\d+(?:\.\d+)?)/i);
		out.m = mMatch ? Number(mMatch[1]) : last.m;

		// Параметры
		const keys = ['X', 'Y', 'I', 'J', 'S', 'P', 'H', 'A', 'L', 'C'];
		for (const k of keys) {
			const r = new RegExp(`${k}(-?\\d+(?:\\.\\d+)?)`, 'i');
			const m = s.match(r);
			if (m) {
				out.params[k] = Number(m[1]);
			} else if (last.params[k] !== undefined) {
				out.params[k] = last.params[k];
			}
		}

		if ( /(Part End)/i.test(s)) {
			out.base = { X: 0, Y: 0, C: 0 };
		}

		// Если это строка с G52 — сохраняем её как базовую
		if (/G52/i.test(s)) {
			base.X = out.params.X;
			base.Y = out.params.Y;
			base.C = out.params.C;
			out.base = base
		} else {
			out.base = {...base}
		}

		// Обновляем last
		last.g = out.g;
		last.m = out.m;
		last.params = { ...last.params, ...out.params };
		console.log (out)
		return out;
	};
}

function gcodeGenSVG(lines, opts = {}) {
	const svgId = opts.svgId || null;
	const noRealSize = !!opts.noRealSize;
	const pulsesPerMM = typeof opts.pulsesPerMM === 'number' ? opts.pulsesPerMM : 1000;
	let sheetDim = opts.sheetDim ? { ...opts.sheetDim } : null;

	// Парсим все строки сразу
	const parseGcodeLine = makeGcodeParser();
	const cmds = lines.map(parseGcodeLine);
	// Если sheetDim не задан, попробуем вытащить из первой G29 с X/Y
	if (!sheetDim) {
		const g29 = cmds.find(c => c.g === 29 && c.params && (c.params.X || c.params.Y));
		if (g29 && g29.params.X && g29.params.Y) {
			sheetDim = { x: g29.params.X, y: g29.params.Y };
		}
	}
	// Значения по умолчанию, если не удалось определить
	if (!sheetDim) sheetDim = { x: 700, y: 700 };

	// Геометрия листа
	const x0 = 0, y0 = 0;
	const x1 = sheetDim.x, y1 = sheetDim.y;
	const dimx = x1 - x0;
	const dimy = y1 - y0;

	// Перевод в «устройства» для viewBox и контура листа, как в C-версии
	const vx0 = toUnits(x0, pulsesPerMM);
	const vy0 = toUnits(y0, pulsesPerMM);
	const vx1 = toUnits(x1, pulsesPerMM);
	const vy1 = toUnits(y1, pulsesPerMM);

	// Толщина обводки равна pulsesPerMM (см. C-код) — применим к стилю группы контуров
	const strokeWidth = '1px'//pulsesPerMM;

	// Параметры маркеров
	//const ddr = Math.floor((3 * pulsesPerMM) / 4); // как ddr в C (3 * pulses >> 2)
	let mjl = Math.max((Math.max(dimx, dimy) * 0.005), 5); // мм
	mjl = Math.floor((mjl * pulsesPerMM) / 4); // в «устройствах»

	// Сборка SVG по строкам
	const out = [];
	const push = (s) => out.push(s);

	push('<?xml version="1.0" encoding="utf-8" ?>');
	let attrs = [`baseProfile="full"`];
	if (svgId) attrs.push(`id="${svgId}"`);
	if (!noRealSize) attrs.push(`width="${dimx.toFixed(2)}" height="${dimy.toFixed(2)}"`);
	attrs.push(`viewBox="${vx0} ${vy0} ${vx1} ${vy1}"`);
	attrs.push(`style="overflow:visible;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"`);
	push(`<svg ${attrs.join(' ')}>`);
	push(`<g class="svg-pan-zoom_viewport">`);
	push(`<g class="sgn_main_pv" style="transform-origin: center;">`);
	push(`<rect class="sgn_sheet" x="${vx0}" y="${vy0}" width="${vx1}" height="${vy1}" fill="url(#grid_pattern)" />`);
	push(`<g class="sgn_main_els" style="fill:none;stroke-width:${strokeWidth};stroke:red;">`);

	// Состояние траекторий
	let cx = vx0, cy = vy0; // текущая точка (в "устройствах"); допустим старт = (0,0)
	let laserOn = false;     // аналог line->laseron
	let pendingBreakCircle = null; // M4/M5 кружки в точке до следующего движения

	// Хелперы рисования
	//const circ = (x, y, rPct, cls) => push(`<circle cx="${x}" cy="${y}" r="${rPct}%" class="${cls}"/>`);
	const line = (x1, y1, x2, y2, cls) => push(`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="${cls}"/>`);
	const cross = (x, y, size, cls) => {
		push(`<path d="M${x - size},${y - size}L${x + size},${y + size}M${x - size},${y + size}L${x + size},${y - size}" class="${cls}"/>`);
	};
	const arcPath = (sx, sy, ex, ey, r, large, sweep, cls) => {
		push(`<path d="M${sx},${sy}A${r},${r} 0,${large},${sweep} ${ex},${ey}" class="${cls}"/>`);
	};

	// Обход команд
	for (const c of cmds) {
		// Комментарии вида (Part ...) нам не мешают — игнорируем в геометрии
		// Обработка M-кодов (до движений)
		if (typeof c.m === 'number') {
			if (!pendingBreakCircle) {
				if (c.m === 4) { // начало реза
					pendingBreakCircle = { type: 'in', n: c.n };
				} else if (c.m === 5) { // конец реза
					pendingBreakCircle = { type: 'out', n: c.n };
				}
			}
			// Смена состояния лазера (предположительно)
			if (c.m === 4) laserOn = true;
			if (c.m === 5) laserOn = false;
		}

		// Обработка G-кодов
		if (typeof c.g === 'number') {
			const g = Math.floor(c.g);
			// Моментальные маркеры «breaking»: G4 — как в C ведём крест и сбрасываем флаг
			if (g === 4) {
				cross(cx + c.base.X, cy + + c.base.Y, mjl, 'sgn_mj');
 				continue;
			}

			// Если был M4/M5 до движения — выведем маленький кружок один раз
			if (pendingBreakCircle) {
				if (pendingBreakCircle.type === 'in') {
					//circ(cx, cy, 0.15, `sgn_brk sgn_incut gline_${c.n ?? 0}`);
				} else {
					//circ(cx, cy, 0.1, `sgn_brk sgn_cutend gline_${c.n ?? 0}`);
				}
				pendingBreakCircle = null;
			}

 			const cls = laserOn ? `sgn_mv sgn_mv${g} gline_${c.n ?? 0}` : `sgn_fm gline_${c.n ?? 0}`;

			if (g === 0 || g === 1) {
				// Линейное перемещение
				const tx = (c.params.X !== undefined) ? toUnits(c.params.X, pulsesPerMM) : cx;
				const ty = (c.params.Y !== undefined) ? toUnits(c.params.Y, pulsesPerMM) : cy;
				line(cx + c.base.X, cy +  c.base.Y, tx+ c.base.X, ty  + c.base.Y, cls);
				cx = tx; cy = ty;
			} else if (g === 2 || g === 3) {
				// Дуговое перемещение по центру I/J (версия без R-параметра)
				const tx = (c.params.X !== undefined) ? toUnits(c.params.X, pulsesPerMM) : cx;
				const ty = (c.params.Y !== undefined) ? toUnits(c.params.Y, pulsesPerMM) : cy;
				const ci = (c.params.I !== undefined) ? toUnits(c.params.I, pulsesPerMM) : 0;
				const cj = (c.params.J !== undefined) ? toUnits(c.params.J, pulsesPerMM) : 0;
				const cx0 = cx + ci; // центр в «устройствах»
				const cy0 = cy + cj;
				const dxs = cx - cx0;
				const dys = cy - cy0;
				const dxe = tx - cx0;
				const dye = ty - cy0;
				//const rs = Math.hypot(dxs, dys);
				//const re = Math.hypot(dxe, dye);
				//const r = Math.round((rs + re) / 2); // усредняем радиус на всякий случай

				let r = Math.round((Math.hypot(tx - ci, ty - cj)) * 1000) / 1000;

				console.log(r)

				// Углы старта/финиша
				const a1 = Math.atan2(dys, dxs);
				const a2 = Math.atan2(dye, dxe);
				let d = normalizeAngle(a2 - a1);
				const ccw = (g === 3);
				if (ccw && d < 0) d += 2 * Math.PI;
				if (!ccw && d > 0) d -= 2 * Math.PI;
				const large = 0//(Math.abs(d) > Math.PI) ? 1 : 0;
				//const sweep = ccw ? 1 : 0;
				const sweep = g === 3 ? 1 : 0;
				arcPath(cx+ c.base.X, cy + c.base.Y, tx+ c.base.X, ty + c.base.Y, r, large, sweep, cls,);
				cx = tx; cy = ty;

			} else if (g === 41 || g === 42 || g === 40) {
 			} else if (g === 28 || g === 52 || g === 99) {
 			} else {
 			}
		}
	}

	// Закрывающие теги
	push('</g>'); // .sgn_main_els
	push('</g>'); // .sgn_main_pv
	push('</g>'); // .svg-pan-zoom_viewport
	push('</svg>');
	return out.join('\n');
}



const GCodeToSvg1 = () => {

	const containerRef = useRef<HTMLDivElement | null>(null);
	const panZoomRef = useRef(null);
	const [svg, setSvg] = useState("");

	useEffect(() => {
		setSvg(gcodeGenSVG(listing.trim().split(/\n+/), { svgId: 'xui', pulsesPerMM: 1000 }))
	}, [])

	useEffect(() => {
		if (!containerRef.current || !svg) return;
		const svgElement = containerRef.current.querySelector("svg");
		if (!svgElement) return;

		// Удаляем старый инстанс
		if (panZoomRef.current) {
			try {
				panZoomRef.current.destroy();
			} catch (e) {
				console.warn("Ошибка destroy:", e);
			}
			panZoomRef.current = null;
		}

		const panZoomInstance = svgPanZoom(svgElement, {
			zoomEnabled: true,
			controlIconsEnabled: false,
			fit: true,
			center: true,
			minZoom: 0.1,
			maxZoom: 20,
		});

		panZoomRef.current = panZoomInstance;

		setTimeout(() => {
			panZoomInstance.resize();
			panZoomInstance.fit();
			panZoomInstance.center();
		}, 0);

		return () => {
			try {
				panZoomInstance.destroy();
			} catch (e) {
				console.warn("Ошибка destroy:", e);
			}
		};
	}, [svg]);

	const fit = () => {
		if (!panZoomRef.current) return;
		panZoomRef.current.fit();
		panZoomRef.current.center();
	};

	const zoom = (dir: string) => {
		if (!panZoomRef.current) return;
		dir === "+" ? panZoomRef.current.zoomIn() : panZoomRef.current.zoomOut();
	};


	return (
		<div
			style={{
				border: "2px solid grey",
				borderRadius: "10px",
				width: "1300px",
				height: "650px",
				touchAction: "none", // 🔥 обязательно для pinch
				position: "relative",
			}}
		>
			{/* Кнопки */}
			<div className="d-flex flex-column position-absolute">
				<div className="mx-2 mt-1">
					<button
						onClick={fit}
						className={`violet_button navbar_button small_button40`} >
						<div className="d-flex align-items-center justify-content-center">
							<Icon icon="carbon:zoom-fit"
								width="36"
								height="36"
								style={{ color: 'white' }}
							/>
						</div>
					</button>
				</div>
				<div className="mx-2 mt-1">
					<button
						onClick={() => zoom('-')}
						className={`violet_button navbar_button small_button40`} >
						<div className="d-flex align-items-center justify-content-center">
							<Icon icon="carbon:zoom-out"
								width="36"
								height="36"
								style={{ color: 'white' }}
							/>
						</div>
					</button>
				</div>
				<div className="mx-2 mt-1">
					<button
						onClick={() => zoom('+')}
						className={`violet_button navbar_button small_button40`} >
						<div className="d-flex align-items-center justify-content-center">
							<Icon icon="carbon:zoom-in"
								width="36"
								height="36"
								style={{ color: 'white' }}
							/>
						</div>
					</button>
				</div>
			</div>

			{/* SVG */}
			<div
				id="workarea"
				ref={containerRef}
				style={{
					border: "none",
					width: "1300px",
					height: "650px",
					display: "flex",
					alignItems: "center",
					justifyContent: "center",
				}}
			>
				{parse(svg)}
			</div>
		</div>

	);
};

export default GCodeToSvg1;


const gcode = {
width:700,
height:700,
// part делится командами (Part code" и 389(Part End)
parts:[
	{
		part:"name....",
		n:[201,225],//номера строк от перед  (Part code"  и  (Part End)
		base: {X:0,Y:0,C:0},
		// контуры делятся командами M4 M5
		contours:{
			cmd:[
				{ g: 1, m: 0, params: {}},
				{ g: 1, m: 0, params: {}},
				{ g: 1, m: 0, params: {}},
				{ g: 1, m: 0, params: {}},
				{ g: 2, m: 0, params: {}},
				{ g: 2, m: 0, params: {}},
				{ g: 3, m: 0, params: {}},
				
			]
		
	}
]}